import{aG as S,aQ as H,aO as M,aF as C,aX as W,a_ as w,bS as D,aY as E,aZ as O}from"./three@0.169.11.js";const f={node:"node",material:"material",camera:"camera",light:"light"},R="KHR_animation_pointer",U={CUBICSPLINE:void 0,LINEAR:H,STEP:W};class j{constructor(r){this.name=R,this.parser=r,this.animationPointerResolver=null}setAnimationPointerResolver(r){return this.animationPointerResolver=r,this}loadAnimationTargetFromChannel(r){const n=r.target,a=n.node!==void 0?n.node:n.id;return this.parser.getDependency("node",a)}loadAnimationTargetFromChannelWithAnimationPointer(r){var c;B();const n=r.target,a=n.extensions&&n.extensions[R]&&n.path&&n.path==="pointer";if(!a)return null;let e,t=f.node,s;if(a){const m=n.extensions[R];let o=m.pointer;if(!o){console.warn("Invalid path",m,n);return}if(o.startsWith("/materials/")?t=f.material:o.startsWith("/extensions/KHR_lights_punctual/lights/")?t=f.light:o.startsWith("/cameras/")&&(t=f.camera),s=this._tryResolveTargetId(o,t),s===null||isNaN(s)){console.warn("Failed resolving animation node id: "+s,o);return}switch(t){case f.material:const x=("/materials/"+s.toString()+"/").length,h=o.substring(0,x);switch(e=o.substring(x),e){case"pbrMetallicRoughness/baseColorFactor":e="color";break;case"pbrMetallicRoughness/roughnessFactor":e="roughness";break;case"pbrMetallicRoughness/metallicFactor":e="metalness";break;case"emissiveFactor":e="emissive";break;case"alphaCutoff":e="alphaTest";break;case"occlusionTexture/strength":e="aoMapIntensity";break;case"normalTexture/scale":e="normalScale";break;case"pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale":e="map/repeat";break;case"pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset":e="map/offset";break;case"emissiveTexture/extensions/KHR_texture_transform/scale":e="emissiveMap/repeat";break;case"emissiveTexture/extensions/KHR_texture_transform/offset":e="emissiveMap/offset";break;case"extensions/KHR_materials_emissive_strength/emissiveStrength":e="emissiveIntensity";break;case"extensions/KHR_materials_transmission/transmissionFactor":e="transmission";break;case"extensions/KHR_materials_ior/ior":e="ior";break;case"extensions/KHR_materials_volume/thicknessFactor":e="thickness";break;case"extensions/KHR_materials_volume/attenuationColor":e="attenuationColor";break;case"extensions/KHR_materials_volume/attenuationDistance":e="attenuationDistance";break;case"extensions/KHR_materials_iridescence/iridescenceFactor":e="iridescence";break;case"extensions/KHR_materials_iridescence/iridescenceIor":e="iridescenceIOR";break;case"extensions/KHR_materials_iridescence/iridescenceThicknessMinimum":e="iridescenceThicknessRange[0]";break;case"extensions/KHR_materials_iridescence/iridescenceThicknessMaximum":e="iridescenceThicknessRange[1]";break;case"extensions/KHR_materials_clearcoat/clearcoatFactor":e="clearcoat";break;case"extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor":e="clearcoatRoughness";break;case"extensions/KHR_materials_sheen/sheenColorFactor":e="sheenColor";break;case"extensions/KHR_materials_sheen/sheenRoughnessFactor":e="sheenRoughness";break;case"extensions/KHR_materials_specular/specularFactor":e="specularIntensity";break;case"extensions/KHR_materials_specular/specularColorFactor":e="specularColor";break}o=h+e;break;case f.node:const u=("/nodes/"+s.toString()+"/").length,l=o.substring(0,u);switch(e=o.substring(u),e){case"translation":e="position";break;case"rotation":e="quaternion";break;case"scale":e="scale";break;case"weights":e="morphTargetInfluences";break}o=l+e;break;case f.light:const p=("/extensions/KHR_lights_punctual/lights/"+s.toString()+"/").length;switch(e=o.substring(p),e){case"color":break;case"intensity":break;case"spot/innerConeAngle":e="penumbra";break;case"spot/outerConeAngle":e="angle";break;case"range":e="distance";break}o="/lights/"+s.toString()+"/"+e;break;case f.camera:const g=("/cameras/"+s.toString()+"/").length,b=o.substring(0,g);switch(e=o.substring(g),e){case"perspective/yfov":e="fov";break;case"perspective/znear":case"orthographic/znear":e="near";break;case"perspective/zfar":case"orthographic/zfar":e="far";break;case"perspective/aspect":e="aspect";break;case"orthographic/xmag":e="zoom";break;case"orthographic/ymag":e="zoom";break}o=b+e;break}(c=this.animationPointerResolver)!=null&&c.resolvePath&&(o=this.animationPointerResolver.resolvePath(o)),n.extensions[R].pointer=o}if(s==null||isNaN(s)){console.warn("Failed resolving animation node id: "+s,n);return}let i;return t===f.node?i=this.parser.getDependency("node",s):t===f.material?i=this.parser.getDependency("material",s):t===f.light?i=this.parser.getDependency("light",s):t===f.camera?i=this.parser.getDependency("camera",s):console.error("Unhandled type",t),i}createAnimationTracksWithAnimationPointer(r,n,a,e,t){if(!(t.extensions&&t.extensions[R]&&t.path&&t.path==="pointer"))return null;let i=t.extensions[R].pointer;if(!i)return null;const c=[];i=i.replaceAll("/",".");const m=i.split(".");var x=r.name!==void 0&&r.name!==null?r.name:r.uuid;if(m[2]=x,m[3]==="morphTargetInfluences"&&r.type==="Group"){for(const u of r.children)u instanceof S&&u.morphTargetInfluences&&(m[3]=u.name,m[4]="morphTargetInfluences",h(this.parser));return c}h(this.parser);function h(u){i=m.join(".");let l;switch(a.itemSize){case 1:l=O;break;case 2:case 3:l=E;break;case 4:i.endsWith(".quaternion")?l=w:l=D;break}if(!l){console.warn("Unsupported output accessor format",a);return}const p=e.interpolation!==void 0?U[e.interpolation]:H;let g=u._getArrayFromAccessor(a);i.endsWith(".fov")&&(g=g.map(k=>k/Math.PI*180));const b=new l(i,n.array,g,p);if(p==="CUBICSPLINE"&&u._createCubicSplineTrackInterpolant(b),c.push(b),i&&a.itemSize===4&&i.startsWith(".materials.")&&i.endsWith(".color")){const k=new Float32Array(g.length/4);for(let T=0,_=g.length/4;T<_;T+=1)k[T]=g[T*4+3];const d=new l(i.replace(".color",".opacity"),n.array,k,p);p==="CUBICSPLINE"&&u._createCubicSplineTrackInterpolant(b),c.push(d)}}return c}_tryResolveTargetId(r,n){let a="";return n==="node"?a=r.substring(7):n==="material"?a=r.substring(11):n==="light"?a=r.substring(39):n==="camera"&&(a=r.substring(9)),a=a.substring(0,a.indexOf("/")),Number.parseInt(a)}loadAnimation(r){const n=this,a=this.parser.json,e=this.parser,t=a.animations[r],s=t.name?t.name:"animation_"+r,i=[],c=[],m=[],o=[],x=[];for(let h=0,u=t.channels.length;h<u;h++){const l=t.channels[h],p=t.samplers[l.sampler],g=l.target,b=t.parameters!==void 0?t.parameters[p.input]:p.input,k=t.parameters!==void 0?t.parameters[p.output]:p.output;let d=n.loadAnimationTargetFromChannelWithAnimationPointer(l);d||(d=n.loadAnimationTargetFromChannel(l)),i.push(d),c.push(e.getDependency("accessor",b)),m.push(e.getDependency("accessor",k)),o.push(p),x.push(g)}return Promise.all([Promise.all(i),Promise.all(c),Promise.all(m),Promise.all(o),Promise.all(x)]).then(function(h){const u=h[0],l=h[1],p=h[2],g=h[3],b=h[4],k=[];for(let d=0,T=u.length;d<T;d++){const _=u[d],v=l[d],A=p[d],N=g[d],K=b[d];if(_===void 0)continue;_.updateMatrix&&(_.updateMatrix(),_.matrixAutoUpdate=!0);let y=n.createAnimationTracksWithAnimationPointer(_,v,A,N,K);if(y||(y=e._createAnimationTracks(_,v,A,N,K)),y)for(let P=0;P<y.length;P++)k.push(y[P])}return new M(s,void 0,k)})}}let F=!1,z=null;function B(){if(F)return;F=!0;const I=z||(z=C.findNode);C.findNode=function(r,n){if(n.startsWith(".materials.")){const a=n.substring(11).substring(n.indexOf(".")),e=a.indexOf("."),t=e<0?a:a.substring(0,e);let s=null;return r.traverse(i=>{s!==null||i.type!=="Mesh"&&i.type!=="SkinnedMesh"||i.material&&(i.material.uuid===t||i.material.name===t)&&(s=i.material,s!==null&&(a.endsWith(".map")?s=s.map:a.endsWith(".emissiveMap")&&(s=s.emissiveMap)))}),s}else if(n.startsWith(".nodes.")||n.startsWith(".lights.")||n.startsWith(".cameras.")){const a=n.split(".");let e;for(let t=1;t<a.length;t++){const s=a[t];if(s.length==36)e=r.getObjectByProperty("uuid",s);else if(e&&e[s]){const c=Number.parseInt(s);let m=s;c>=0&&(m=c),e=e[m]}else{const c=r.getObjectByName(s);c&&(e=c)}}if(!e){const t=I(r,a[2]);return t||console.warn(R+": Property binding not found",n,r,r.name,a),t}return e}return I(r,n)}}export{j as GLTFAnimationPointerExtension,j as default};
